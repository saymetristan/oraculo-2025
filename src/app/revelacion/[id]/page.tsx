'use client'\n\nimport { useEffect, useState } from 'react'\nimport { motion } from 'framer-motion'\nimport { useParams, useSearchParams } from 'next/navigation'\nimport { TarotCard } from '@/components/results/TarotCard'\nimport { ProphecyCard } from '@/components/results/ProphecyCard'\nimport { PaywallSection } from '@/components/results/PaywallSection'\nimport { OrnamentDivider } from '@/components/ui/OrnamentDivider'\nimport { ParticleEffect } from '@/components/ui/ParticleEffect'\nimport { Button } from '@/components/ui/Button'\nimport { OracleReading } from '@/lib/types'\nimport { loadStripe } from '@stripe/stripe-js'\n\nconst stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!)\n\nexport default function RevelacionPage() {\n  const params = useParams()\n  const searchParams = useSearchParams()\n  const [reading, setReading] = useState<OracleReading | null>(null)\n  const [isPaid, setIsPaid] = useState(false)\n  const [isLoading, setIsLoading] = useState(false)\n\n  useEffect(() => {\n    const loadReading = async () => {\n      // Check if payment was successful\n      if (searchParams.get('success') === 'true') {\n        setIsPaid(true)\n      }\n\n      // First, try to load from localStorage\n      const storedReading = localStorage.getItem('oracle_reading')\n      if (storedReading) {\n        const parsed = JSON.parse(storedReading)\n        if (parsed.id === params.id) {\n          setReading(parsed)\n          return\n        }\n      }\n\n      // If not in localStorage, fetch from API\n      try {\n        const response = await fetch(`/api/generate?id=${params.id}`)\n        if (response.ok) {\n          const data = await response.json()\n          setReading(data)\n          // Store in localStorage for future visits\n          localStorage.setItem('oracle_reading', JSON.stringify(data))\n        }\n      } catch (error) {\n        console.error('Error loading reading:', error)\n      }\n    }\n\n    loadReading()\n  }, [params.id, searchParams])\n\n  const handleUnlock = async (tier: 'lectura' | 'pack') => {\n    setIsLoading(true)\n    try {\n      const response = await fetch('/api/checkout', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          tier,\n          readingId: reading?.id,\n        }),\n      })\n\n      const { sessionId } = await response.json()\n      \n      const stripe = await stripePromise\n      if (stripe) {\n        await stripe.redirectToCheckout({ sessionId })\n      }\n    } catch (error) {\n      console.error('Checkout error:', error)\n      setIsLoading(false)\n    }\n  }\n\n  const handleShare = async () => {\n    const shareText = `✧ El Oráculo 2025 ✧\\n\\nMi carta: ${reading?.carta_nombre}\\n\\n\"${reading?.veredicto}\"\\n\\nDescubre tu lectura en:`\n    const shareUrl = window.location.href\n\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: 'Mi Lectura del Oráculo 2025',\n          text: shareText,\n          url: shareUrl,\n        })\n      } catch (err) {\n        console.log('Share cancelled')\n      }\n    } else {\n      // Fallback: copy to clipboard\n      await navigator.clipboard.writeText(`${shareText} ${shareUrl}`)\n      alert('¡Enlace copiado al portapapeles!')\n    }\n  }\n\n  if (!reading) {\n    return (\n      <main className=\"min-h-screen flex items-center justify-center\">\n        <p className=\"font-body text-bronze\">Cargando tu lectura...</p>\n      </main>\n    )\n  }\n\n  return (\n    <main className=\"min-h-screen relative\">\n      <ParticleEffect />\n\n      {/* Header */}\n      <section className=\"py-12 px-6 text-center\">\n        <motion.div\n          initial={{ opacity: 0, y: -20 }}\n          animate={{ opacity: 1, y: 0 }}\n        >\n          <span className=\"text-4xl text-gold\">◈</span>\n          <h1 className=\"font-display text-3xl md:text-4xl mt-4\">Tu Revelación</h1>\n          <p className=\"font-body text-bronze mt-2 italic\">El Oráculo ha hablado</p>\n        </motion.div>\n      </section>\n\n      {/* Tarot Card Section */}\n      <section className=\"py-12 px-6\">\n        <div className=\"max-w-4xl mx-auto flex flex-col items-center\">\n          <motion.h2\n            className=\"font-display text-2xl mb-8 text-center\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ delay: 0.3 }}\n          >\n            Tu Carta Personal\n          </motion.h2>\n\n          <TarotCard\n            name={reading.carta_nombre}\n            meaning={reading.carta_significado}\n            imageBase64={reading.carta_imagen}\n            isRevealed={true}\n            isPremium={isPaid}\n          />\n        </div>\n      </section>\n\n      <OrnamentDivider symbol=\"✦\" className=\"max-w-xl mx-auto\" />\n\n      {/* Veredicto Section */}\n      <section className=\"py-12 px-6\">\n        <div className=\"max-w-2xl mx-auto text-center\">\n          <motion.h2\n            className=\"font-display text-2xl mb-6\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.5 }}\n          >\n            El Veredicto de tu 2024\n          </motion.h2>\n\n          <motion.blockquote\n            className=\"font-body text-xl md:text-2xl text-bronze italic leading-relaxed\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.6 }}\n          >\n            \"{reading.veredicto}\"\n          </motion.blockquote>\n        </div>\n      </section>\n\n      <OrnamentDivider symbol=\"◇\" className=\"max-w-xl mx-auto\" />\n\n      {/* Profecías Section */}\n      <section className=\"py-12 px-6\">\n        <div className=\"max-w-2xl mx-auto\">\n          <motion.h2\n            className=\"font-display text-2xl mb-8 text-center\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.7 }}\n          >\n            Tus Profecías para 2025\n          </motion.h2>\n\n          <div className=\"space-y-6\">\n            {reading.profecias.map((prophecy, index) => (\n              <ProphecyCard\n                key={prophecy.numero}\n                prophecy={prophecy}\n                isLocked={prophecy.es_premium && !isPaid}\n                index={index}\n              />\n            ))}\n          </div>\n        </div>\n      </section>\n\n      {/* Elemento Section */}\n      <section className=\"py-12 px-6 bg-cream-dark/30\">\n        <div className=\"max-w-2xl mx-auto text-center\">\n          <motion.h2\n            className=\"font-display text-2xl mb-4\"\n            initial={{ opacity: 0 }}\n            whileInView={{ opacity: 1 }}\n            viewport={{ once: true }}\n          >\n            Tu Elemento: {reading.elemento.nombre}\n          </motion.h2>\n          \n          <motion.p\n            className=\"font-body text-bronze leading-relaxed\"\n            initial={{ opacity: 0 }}\n            whileInView={{ opacity: 1 }}\n            viewport={{ once: true }}\n          >\n            {reading.elemento.interpretacion}\n          </motion.p>\n        </div>\n      </section>\n\n      {/* Ritual de Cierre (Premium) */}\n      {isPaid && reading.ritual_cierre && (\n        <section className=\"py-12 px-6\">\n          <div className=\"max-w-2xl mx-auto\">\n            <motion.div\n              className=\"card-mystical\"\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n            >\n              <h2 className=\"font-display text-2xl mb-6 text-center\">\n                ✧ Ritual de Cierre ✧\n              </h2>\n              <p className=\"font-body text-bronze leading-relaxed whitespace-pre-line\">\n                {reading.ritual_cierre}\n              </p>\n            </motion.div>\n          </div>\n        </section>\n      )}\n\n      {/* Paywall */}\n      {!isPaid && (\n        <PaywallSection onUnlock={handleUnlock} isLoading={isLoading} />\n      )}\n\n      {/* Share Section */}\n      <section className=\"py-16 px-6 text-center\">\n        <motion.div\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n        >\n          <h2 className=\"font-display text-2xl mb-4\">Comparte tu Lectura</h2>\n          <p className=\"font-body text-bronze mb-6\">\n            Deja que otros descubran lo que el Oráculo tiene para ellos\n          </p>\n          <Button variant=\"secondary\" onClick={handleShare}>\n            Compartir ✧\n          </Button>\n        </motion.div>\n      </section>\n\n      {/* Footer */}\n      <footer className=\"py-8 px-6 border-t border-bronze/10 text-center\">\n        <p className=\"text-bronze/60 font-sans text-sm\">\n          © 2024 El Oráculo. Que 2025 sea tu mejor año.\n        </p>\n      </footer>\n    </main>\n  )\n}\n